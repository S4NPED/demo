#!/bin/bash
# Полная настройка HQ-RTR для демонстрационного экзамена 2026
# Debian 13

set -e

echo "========================================"
echo "Настройка HQ-RTR (Debian 13)"
echo "========================================"

# 3. Перезапуск FRR
echo "Перезапускаем FRR..."
systemctl restart frr

# 4. Настройка OSPF через vtysh
echo "Настраиваем OSPF..."
vtysh << EOF
conf t
router ospf
router-id 1.1.1.1
no passive-interface default
network 192.168.100.0/27 area 0
network 192.168.100.32/28 area 0
network 10.10.0.0/30 area 0
area 0 authentication
int tun1
no ip ospf passive
no ip ospf network broadcast
ip ospf authentication
ip ospf authentication-key password
exit
exit
wr
EOF

# 11. Установка и настройка DHCP сервера
echo "11. Установка DHCP сервера..."
apt install -y isc-dhcp-server

# Настраиваем интерфейс для DHCP
cat > /etc/default/isc-dhcp-server << 'EOF'
INTERFACESv4="vlan200"
INTERFACESv6=""
EOF

# Настраиваем DHCP
cat > /etc/dhcp/dhcpd.conf << 'EOF'
option domain-name "au-team.irpo";
option domain-name-servers 192.168.100.2;

default-lease-time 600;
max-lease-time 7200;

ddns-update-style none;

authoritative;

subnet 192.168.100.32 netmask 255.255.255.240 {
    range 192.168.100.34 192.168.100.47;
    option routers 192.168.100.33;
}
EOF

echo "========================================"
echo "Настройка HQ-RTR завершена!"
echo "========================================"
echo "Используйте: check-hq-rtr для проверки"
